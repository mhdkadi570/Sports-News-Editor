<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محرر أخبار كرة القدم — API-SPORTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.06rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .spinner { display:inline-block; width:1.1rem; height:1.1rem; border:.18rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-3 p-md-4">

<div class="container">
  <h3 class="mb-4">📰 محرر أخبار نتائج كرة القدم</h3>

  <!-- API Options -->
  <div class="row g-3 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">المزوّد</label>
      <select id="provider" class="form-select">
        <option value="apisports" selected>API-SPORTS</option>
        <option value="rapidapi">RapidAPI</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">API Key</label>
      <input id="apiKey" class="form-control mono" type="password" placeholder="ضع مفتاحك هنا">
    </div>
    <div class="col-md-2">
      <label class="form-label">اليوم</label>
      <select id="daySelect" class="form-select">
        <option value="today">اليوم</option>
        <option value="yesterday">الأمس</option>
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button id="refreshBtn" class="btn btn-outline-secondary">🔄 تحديث</button>
    </div>
  </div>

  <!-- League -->
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label class="form-label">الدوري (قائمة جاهزة)</label>
      <select id="leagueSelect" class="form-select">
        <option value="39">الدوري الإنجليزي الممتاز (39)</option>
        <option value="140">الدوري الإسباني (140)</option>
        <option value="135">الدوري الإيطالي (135)</option>
        <option value="78">الدوري الألماني (78)</option>
        <option value="61">الدوري الفرنسي (61)</option>
        <option value="2">دوري أبطال أوروبا (2)</option>
        <option value="3">الدوري الأوروبي (3)</option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">League ID (اختياري)</label>
      <input id="leagueIdManual" class="form-control mono" type="text" placeholder="مثال: 200 (للدوريات العربية)">
    </div>
  </div>

  <!-- Matches -->
  <div class="row g-3 mb-3">
    <div class="col-md-8">
      <label class="form-label">المباراة</label>
      <select id="matchSelect" class="form-select">
        <option value="">— اختر الدوري واضغط تحميل —</option>
      </select>
    </div>
    <div class="col-md-4 d-grid">
      <button id="loadMatchesBtn" class="btn btn-primary">📥 تحميل المباريات</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">لغة الجولة</label>
      <select id="roundLang" class="form-select">
        <option value="arabic" selected>عربي (الجولة 7)</option>
        <option value="raw">كما في الـ API</option>
      </select>
    </div>
    <div class="col-md-8 d-grid d-md-flex gap-2">
      <button id="generateBtn" class="btn btn-success flex-fill" disabled>✍️ توليد الخبر</button>
      <button id="rephraseBtn" class="btn btn-outline-primary flex-fill" disabled>🔁 غيّر الصياغة</button>
      <button id="copyBtn" class="btn btn-outline-dark flex-fill" disabled>📋 نسخ النص</button>
      <button id="clearBtn" class="btn btn-outline-danger flex-fill">🧹 مسح</button>
    </div>
  </div>

  <!-- Output -->
  <div class="mb-3">
    <label class="form-label">النص الإخباري</label>
    <textarea id="newsOutput" rows="12" class="form-control"></textarea>
  </div>

  <div id="statusArea" class="text-muted small"></div>
</div>

<script>
async function tryFixtures(urls) {
  for (const u of urls) {
    try {
      const data = await httpGet(u);
      const arr = data.response || [];
      if (arr.length) return { ok: true, url: u, fixtures: arr };
      var lastUrl = u; // keep last tried
    } catch (e) {
      // لو خطأ في أحد الروابط نجرّب الذي بعده
      var lastError = e;
    }
  }
  return { ok: false, url: lastUrl, fixtures: [], err: lastError };
}

async function loadMatches(){
  const leagueId = getLeagueId();
  if(!leagueId){ alert("يرجى اختيار الدوري أو إدخال League ID."); return; }

  const ymd = getYMD(); // تاريخ اليوم/الأمس من الواجهة
  setStatus(`جلب مباريات ${ymd} للدوري ${leagueId}… <span class="spinner"></span>`);
  $("matchSelect").innerHTML = `<option>جاري التحميل...</option>`;
  $("generateBtn").disabled = true;

  // محاولات ذكية
  const urls = [
    // 1) التاريخ مع توقيت قطر
    `/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}&timezone=Asia/Qatar`,
    // 2) نفس اليوم بدون timezone
    `/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}`,
    // 3) نطاق اليوم بالكامل بتوقيت قطر
    `/fixtures?league=${encodeURIComponent(leagueId)}&from=${ymd}T00:00&to=${ymd}T23:59&timezone=Asia/Qatar`,
    // 4) نطاق اليوم بدون تحديد الدوري (للتأكد من رجوع Matches) — سنرشّح محليًا
    `/fixtures?from=${ymd}T00:00&to=${ymd}T23:59&timezone=Asia/Qatar`
  ];

  const res = await tryFixtures(urls);

  let fixtures = res.fixtures;
  // لو جلبنا بدون دوري في المحاولة 4، نرشّح محليًا
  if (res.ok && res.url.startsWith("/fixtures?from=") && fixtures.length) {
    fixtures = fixtures.filter(f => String(f.league?.id) === String(leagueId));
  }

  if (!res.ok || !fixtures.length) {
    setStatus(`<span class="text-danger">لا توجد مباريات لمدخلاتك. آخر محاولة: <code>${res.url || "—"}</code>${res.err ? " — " + res.err : ""}</span>`);
    $("matchSelect").innerHTML = `<option value="">لا مباريات</option>`;
    return;
  }

  // تعبئة القائمة
  $("matchSelect").innerHTML = "";
  fixtures.forEach(f => {
    const opt = document.createElement("option");
    opt.value = JSON.stringify({
      fixtureId: f.fixture.id,
      leagueId: leagueId,
      season: f.league?.season,
      homeId: f.teams?.home?.id,
      awayId: f.teams?.away?.id
    });
    opt.textContent = `${f.teams.home.name} ضد ${f.teams.away.name} — ${(f.goals.home ?? "")}:${(f.goals.away ?? "")}`;
    $("matchSelect").appendChild(opt);
  });

  $("generateBtn").disabled = false;
  setStatus(`تم تحميل ${fixtures.length} مباراة. (المصدر: <code>${res.url}</code>)`);
}
</script>

</body>
</html>

