<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… â€” API-SPORTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.06rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .spinner { display:inline-block; width:1.1rem; height:1.1rem; border:.18rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-3 p-md-4">

<div class="container">
  <h3 class="mb-4">ğŸ“° Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± Ù†ØªØ§Ø¦Ø¬ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…</h3>

  <!-- API Options -->
  <div class="row g-3 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯</label>
      <select id="provider" class="form-select">
        <option value="apisports" selected>API-SPORTS</option>
        <option value="rapidapi">RapidAPI</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">API Key</label>
      <input id="apiKey" class="form-control mono" type="password" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§">
    </div>
    <div class="col-md-2">
      <label class="form-label">Ø§Ù„ÙŠÙˆÙ…</label>
      <select id="daySelect" class="form-select">
        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
        <option value="yesterday">Ø§Ù„Ø£Ù…Ø³</option>
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button id="refreshBtn" class="btn btn-outline-secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>

  <!-- League -->
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label class="form-label">Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù‡Ø²Ø©)</label>
      <select id="leagueSelect" class="form-select">
        <option value="39">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø§Ù„Ù…Ù…ØªØ§Ø² (39)</option>
        <option value="140">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ (140)</option>
        <option value="135">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ (135)</option>
        <option value="78">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ (78)</option>
        <option value="61">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ (61)</option>
        <option value="2">Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Ø£ÙˆØ±ÙˆØ¨Ø§ (2)</option>
        <option value="3">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ (3)</option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">League ID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="leagueIdManual" class="form-control mono" type="text" placeholder="Ù…Ø«Ø§Ù„: 200 (Ù„Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)">
    </div>
  </div>

  <!-- Matches -->
  <div class="row g-3 mb-3">
    <div class="col-md-8">
      <label class="form-label">Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</label>
      <select id="matchSelect" class="form-select">
        <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙˆØ§Ø¶ØºØ· ØªØ­Ù…ÙŠÙ„ â€”</option>
      </select>
    </div>
    <div class="col-md-4 d-grid">
      <button id="loadMatchesBtn" class="btn btn-primary">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">Ù„ØºØ© Ø§Ù„Ø¬ÙˆÙ„Ø©</label>
      <select id="roundLang" class="form-select">
        <option value="arabic" selected>Ø¹Ø±Ø¨ÙŠ (Ø§Ù„Ø¬ÙˆÙ„Ø© 7)</option>
        <option value="raw">ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù€ API</option>
      </select>
    </div>
    <div class="col-md-8 d-grid d-md-flex gap-2">
      <button id="generateBtn" class="btn btn-success flex-fill" disabled>âœï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±</button>
      <button id="rephraseBtn" class="btn btn-outline-primary flex-fill" disabled>ğŸ” ØºÙŠÙ‘Ø± Ø§Ù„ØµÙŠØ§ØºØ©</button>
      <button id="copyBtn" class="btn btn-outline-dark flex-fill" disabled>ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
      <button id="clearBtn" class="btn btn-outline-danger flex-fill">ğŸ§¹ Ù…Ø³Ø­</button>
    </div>
  </div>

  <!-- Output -->
  <div class="mb-3">
    <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ</label>
    <textarea id="newsOutput" rows="12" class="form-control"></textarea>
  </div>

  <div id="statusArea" class="text-muted small"></div>
</div>

<script>
async function tryFixtures(urls) {
  for (const u of urls) {
    try {
      const data = await httpGet(u);
      const arr = data.response || [];
      if (arr.length) return { ok: true, url: u, fixtures: arr };
      var lastUrl = u; // keep last tried
    } catch (e) {
      // Ù„Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù†Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø°ÙŠ Ø¨Ø¹Ø¯Ù‡
      var lastError = e;
    }
  }
  return { ok: false, url: lastUrl, fixtures: [], err: lastError };
}

async function loadMatches(){
  const leagueId = getLeagueId();
  if(!leagueId){ alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ League ID."); return; }

  const ymd = getYMD(); // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ù…Ø³ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  setStatus(`Ø¬Ù„Ø¨ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ${ymd} Ù„Ù„Ø¯ÙˆØ±ÙŠ ${leagueId}â€¦ <span class="spinner"></span>`);
  $("matchSelect").innerHTML = `<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>`;
  $("generateBtn").disabled = true;

  // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø°ÙƒÙŠØ©
  const urls = [
    // 1) Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ ØªÙˆÙ‚ÙŠØª Ù‚Ø·Ø±
    `/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}&timezone=Asia/Qatar`,
    // 2) Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† timezone
    `/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}`,
    // 3) Ù†Ø·Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨ØªÙˆÙ‚ÙŠØª Ù‚Ø·Ø±
    `/fixtures?league=${encodeURIComponent(leagueId)}&from=${ymd}T00:00&to=${ymd}T23:59&timezone=Asia/Qatar`,
    // 4) Ù†Ø·Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø¬ÙˆØ¹ Matches) â€” Ø³Ù†Ø±Ø´Ù‘Ø­ Ù…Ø­Ù„ÙŠÙ‹Ø§
    `/fixtures?from=${ymd}T00:00&to=${ymd}T23:59&timezone=Asia/Qatar`
  ];

  const res = await tryFixtures(urls);

  let fixtures = res.fixtures;
  // Ù„Ùˆ Ø¬Ù„Ø¨Ù†Ø§ Ø¨Ø¯ÙˆÙ† Ø¯ÙˆØ±ÙŠ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 4ØŒ Ù†Ø±Ø´Ù‘Ø­ Ù…Ø­Ù„ÙŠÙ‹Ø§
  if (res.ok && res.url.startsWith("/fixtures?from=") && fixtures.length) {
    fixtures = fixtures.filter(f => String(f.league?.id) === String(leagueId));
  }

  if (!res.ok || !fixtures.length) {
    setStatus(`<span class="text-danger">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„Ù…Ø¯Ø®Ù„Ø§ØªÙƒ. Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©: <code>${res.url || "â€”"}</code>${res.err ? " â€” " + res.err : ""}</span>`);
    $("matchSelect").innerHTML = `<option value="">Ù„Ø§ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</option>`;
    return;
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  $("matchSelect").innerHTML = "";
  fixtures.forEach(f => {
    const opt = document.createElement("option");
    opt.value = JSON.stringify({
      fixtureId: f.fixture.id,
      leagueId: leagueId,
      season: f.league?.season,
      homeId: f.teams?.home?.id,
      awayId: f.teams?.away?.id
    });
    opt.textContent = `${f.teams.home.name} Ø¶Ø¯ ${f.teams.away.name} â€” ${(f.goals.home ?? "")}:${(f.goals.away ?? "")}`;
    $("matchSelect").appendChild(opt);
  });

  $("generateBtn").disabled = false;
  setStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${fixtures.length} Ù…Ø¨Ø§Ø±Ø§Ø©. (Ø§Ù„Ù…ØµØ¯Ø±: <code>${res.url}</code>)`);
}
</script>

</body>
</html>

