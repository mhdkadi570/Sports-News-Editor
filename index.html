<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุญุฑุฑ ุฃุฎุจุงุฑ ูุฑุฉ ุงููุฏู โ API-SPORTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.06rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .spinner { display:inline-block; width:1.1rem; height:1.1rem; border:.18rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-3 p-md-4">

<div class="container">
  <h3 class="mb-4">๐ฐ ูุญุฑุฑ ุฃุฎุจุงุฑ ูุชุงุฆุฌ ูุฑุฉ ุงููุฏู</h3>

  <!-- API Options -->
  <div class="row g-3 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">ุงููุฒููุฏ</label>
      <select id="provider" class="form-select">
        <option value="apisports" selected>API-SPORTS</option>
        <option value="rapidapi">RapidAPI</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">API Key</label>
      <input id="apiKey" class="form-control mono" type="password" placeholder="ุถุน ููุชุงุญู ููุง">
    </div>
    <div class="col-md-2">
      <label class="form-label">ุงูููู</label>
      <select id="daySelect" class="form-select">
        <option value="today">ุงูููู</option>
        <option value="yesterday">ุงูุฃูุณ</option>
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button id="refreshBtn" class="btn btn-outline-secondary">๐ ุชุญุฏูุซ</button>
    </div>
  </div>

  <!-- League -->
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <label class="form-label">ุงูุฏูุฑู (ูุงุฆูุฉ ุฌุงูุฒุฉ)</label>
      <select id="leagueSelect" class="form-select">
        <option value="39">ุงูุฏูุฑู ุงูุฅูุฌููุฒู ุงูููุชุงุฒ (39)</option>
        <option value="140">ุงูุฏูุฑู ุงูุฅุณุจุงูู (140)</option>
        <option value="135">ุงูุฏูุฑู ุงูุฅูุทุงูู (135)</option>
        <option value="78">ุงูุฏูุฑู ุงูุฃููุงูู (78)</option>
        <option value="61">ุงูุฏูุฑู ุงููุฑูุณู (61)</option>
        <option value="2">ุฏูุฑู ุฃุจุทุงู ุฃูุฑูุจุง (2)</option>
        <option value="3">ุงูุฏูุฑู ุงูุฃูุฑูุจู (3)</option>
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">League ID (ุงุฎุชูุงุฑู)</label>
      <input id="leagueIdManual" class="form-control mono" type="text" placeholder="ูุซุงู: 200 (ููุฏูุฑูุงุช ุงูุนุฑุจูุฉ)">
    </div>
  </div>

  <!-- Matches -->
  <div class="row g-3 mb-3">
    <div class="col-md-8">
      <label class="form-label">ุงููุจุงุฑุงุฉ</label>
      <select id="matchSelect" class="form-select">
        <option value="">โ ุงุฎุชุฑ ุงูุฏูุฑู ูุงุถุบุท ุชุญููู โ</option>
      </select>
    </div>
    <div class="col-md-4 d-grid">
      <button id="loadMatchesBtn" class="btn btn-primary">๐ฅ ุชุญููู ุงููุจุงุฑูุงุช</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">ูุบุฉ ุงูุฌููุฉ</label>
      <select id="roundLang" class="form-select">
        <option value="arabic" selected>ุนุฑุจู (ุงูุฌููุฉ 7)</option>
        <option value="raw">ููุง ูู ุงูู API</option>
      </select>
    </div>
    <div class="col-md-8 d-grid d-md-flex gap-2">
      <button id="generateBtn" class="btn btn-success flex-fill" disabled>โ๏ธ ุชูููุฏ ุงูุฎุจุฑ</button>
      <button id="rephraseBtn" class="btn btn-outline-primary flex-fill" disabled>๐ ุบููุฑ ุงูุตูุงุบุฉ</button>
      <button id="copyBtn" class="btn btn-outline-dark flex-fill" disabled>๐ ูุณุฎ ุงููุต</button>
      <button id="clearBtn" class="btn btn-outline-danger flex-fill">๐งน ูุณุญ</button>
    </div>
  </div>

  <!-- Output -->
  <div class="mb-3">
    <label class="form-label">ุงููุต ุงูุฅุฎุจุงุฑู</label>
    <textarea id="newsOutput" rows="12" class="form-control"></textarea>
  </div>

  <div id="statusArea" class="text-muted small"></div>
</div>

<script>
const HOSTS = {
  apisports: "https://v3.football.api-sports.io",
  rapidapi: "https://api-football-v1.p.rapidapi.com/v3"
};
const $ = id => document.getElementById(id);

function setStatus(msg){ $("statusArea").innerHTML = msg; }
function fmtNum(n){ return new Intl.NumberFormat('ar-EG').format(n); }
function minuteArabic(m){ return isNaN(m)?`ุงูุฏูููุฉ ${m}`:`ุงูุฏูููุฉ ${fmtNum(m)}`; }
function toArabicRound(r){ const m=r?.match(/- (\\d+)/); return m?`ุงูุฌููุฉ ${m[1]}`:r; }

function getHeaders(){
  const key=$("apiKey").value.trim();
  if(!key) throw new Error("ุฃุฏุฎู API Key");
  if($("provider").value==="apisports") return {"x-apisports-key":key};
  return {"x-rapidapi-key":key,"x-rapidapi-host":"api-football-v1.p.rapidapi.com"};
}
function getLeagueId(){ return $("leagueIdManual").value.trim()||$("leagueSelect").value; }
function getYMD(){ let d=new Date(); if($("daySelect").value==="yesterday")d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

async function httpGet(path){
  const res=await fetch(HOSTS[$("provider").value]+path,{headers:getHeaders()});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

$("loadMatchesBtn").onclick=async ()=>{
  const id=getLeagueId(), ymd=getYMD();
  setStatus("ุฌูุจ ุงููุจุงุฑูุงุช...");
  const data=await httpGet(`/fixtures?league=${id}&date=${ymd}&timezone=Asia/Qatar`);
  const ms=data.response||[];
  $("matchSelect").innerHTML="";
  ms.forEach(m=>{
    let opt=document.createElement("option");
    opt.value=JSON.stringify({fixtureId:m.fixture.id,leagueId:id,season:m.league.season,homeId:m.teams.home.id,awayId:m.teams.away.id});
    opt.textContent=`${m.teams.home.name} ุถุฏ ${m.teams.away.name} (${m.goals.home}:${m.goals.away})`;
    $("matchSelect").appendChild(opt);
  });
  $("generateBtn").disabled=!ms.length;
};

let lastPayload={}, idx=0;
function buildReport(p){
  const round=$("roundLang").value==="arabic"?toArabicRound(p.round):p.round;
  const goals=p.goals.length?"ุฃูุฏุงู ุงููุจุงุฑุงุฉ: "+p.goals.map(g=>`${g.player} (${g.team}) ูู ${minuteArabic(g.minute)}`).join(" / "):"";
  const reds=p.reds.length?"ุงูุจุทุงูุงุช ุงูุญูุฑุงุก: "+p.reds.map(r=>`${r.player} (${r.team}) ูู ${minuteArabic(r.minute)}`).join(" / "):"";
  const lead=[`${p.home} ู${p.away} ุชูุงุจูุง ุถูู ${p.league} ${round}, ูุงูุชูุช ${p.homeGoals}โ${p.awayGoals}.`,
              `ูู ${p.league}${round? " "+round:""}, ุงูุชูุช ุงูููุงุฌูุฉ ${p.homeGoals}โ${p.awayGoals} ุจูู ${p.home} ู${p.away}.`][idx%2];
  const tail=`ุงูุชุฑุชูุจ: ${p.home} ${p.homePos}, ${p.away} ${p.awayPos}.`;
  return [lead,goals,reds,tail].filter(Boolean).join("\\n");
}

$("generateBtn").onclick=async ()=>{
  const {fixtureId,leagueId,season,homeId,awayId}=JSON.parse($("matchSelect").value);
  const f=await httpGet(`/fixtures?id=${fixtureId}`);
  const fx=f.response[0];
  const e=await httpGet(`/fixtures/events?fixture=${fixtureId}`);
  const goals=e.response.filter(x=>x.type==="Goal").map(x=>({player:x.player?.name,team:x.team?.name,minute:x.time?.elapsed}));
  const reds=e.response.filter(x=>x.detail==="Red Card").map(x=>({player:x.player?.name,team:x.team?.name,minute:x.time?.elapsed}));
  const s=await httpGet(`/standings?league=${leagueId}&season=${season}`);
  const table=[].concat(...s.response[0].league.standings);
  const homePos=table.find(r=>r.team.id===homeId)?.rank??"โ";
  const awayPos=table.find(r=>r.team.id===awayId)?.rank??"โ";
  lastPayload={league:fx.league.name,round:fx.league.round,home:fx.teams.home.name,away:fx.teams.away.name,
              homeGoals:fx.goals.home,awayGoals:fx.goals.away,goals,reds,homePos,awayPos};
  idx=0;
  $("newsOutput").value=buildReport(lastPayload);
  $("rephraseBtn").disabled=$("copyBtn").disabled=false;
};

$("rephraseBtn").onclick=()=>{ idx++; $("newsOutput").value=buildReport(lastPayload); };
$("copyBtn").onclick=async()=>{ await navigator.clipboard.writeText($("newsOutput").value); setStatus("โ ููุณุฎ ุงููุต"); };
$("clearBtn").onclick=()=>{ $("newsOutput").value=""; };
</script>
</body>
</html>
