<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… â€” API-SPORTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.06rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .spinner { display:inline-block; width:1.1rem; height:1.1rem; border:.18rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-3 p-md-4">

<div class="container">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">ğŸ“° Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± Ù†ØªØ§Ø¦Ø¬ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…</h3>
    <span class="text-muted small">v2.0 â€” API-SPORTS</span>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">

      <!-- Provider & Keys -->
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Ø§Ù„Ù…Ø²ÙˆÙ‘Ø¯</label>
          <select id="provider" class="form-select">
            <option value="apisports" selected>API-SPORTS (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</option>
            <option value="rapidapi">RapidAPI</option>
          </select>
          <div class="form-text">
            API-SPORTS: <code>https://v3.football.api-sports.io</code><br>
            RapidAPI: <code>https://api-football-v1.p.rapidapi.com/v3</code>
          </div>
        </div>

        <div class="col-12 col-md-5">
          <label class="form-label">API Key</label>
          <!-- Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§Ø› ÙŠÙ…ÙƒÙ† Ù„ØµÙ‚ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙŠ Ø²ÙˆÙ‘Ø¯ØªÙ†ÙŠ Ø¨Ù‡ -->
          <input id="apiKey" class="form-control mono" type="password" placeholder="Ø§Ù„ØµÙ‚ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§ (x-apisports-key Ø£Ùˆ x-rapidapi-key)">
          <div class="form-text">Ù„Ù€ API-SPORTS Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø£Ø³: <code>x-apisports-key</code> / Ù„Ù€ RapidAPI Ø§Ø³ØªØ®Ø¯Ù… <code>x-rapidapi-key</code>.</div>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Ø§Ù„ÙŠÙˆÙ…</label>
          <select id="daySelect" class="form-select">
            <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
            <option value="yesterday">Ø§Ù„Ø£Ù…Ø³</option>
          </select>
        </div>

        <div class="col-12 col-md-2 d-grid">
          <button id="refreshBtn" class="btn btn-outline-secondary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</button>
        </div>
      </div>

      <hr>

      <!-- League pick -->
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù‡Ø²Ø©)</label>
          <select id="leagueSelect" class="form-select">
            <!-- Ø£Ø´Ù‡Ø± Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª (API-FOOTBALL IDs) -->
            <option value="39">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø§Ù„Ù…Ù…ØªØ§Ø² (EPL / 39)</option>
            <option value="140">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ (LaLiga / 140)</option>
            <option value="135">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ (Serie A / 135)</option>
            <option value="78">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ (Bundesliga / 78)</option>
            <option value="61">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ (Ligue 1 / 61)</option>
            <option value="2">Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Ø£ÙˆØ±ÙˆØ¨Ø§ (UCL / 2)</option>
            <option value="3">Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ (UEL / 3)</option>
          </select>
          <div class="form-text">Ø§Ø®ØªØ± Ø³Ø±ÙŠØ¹Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø£Ùˆ Ø£Ø¯Ø®Ù„ League ID ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ø£ÙŠ Ø¯ÙˆØ±ÙŠ Ø¢Ø®Ø±.</div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">League ID (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="leagueIdManual" class="form-control mono" type="text" placeholder="Ù…Ø«Ø§Ù„: 39 â€” Ø¥Ù† Ø£Ø¯Ø®Ù„ØªÙ‡ Ø³ØªØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©">
          <div class="form-text">Ù„Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„Ù…Ø­Ù„ÙŠØ©) Ø¶Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù€League ID Ù‡Ù†Ø§.</div>
        </div>
      </div>

      <!-- Matches -->
      <div class="row g-3 mt-1">
        <div class="col-12 col-md-8">
          <label class="form-label">Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</label>
          <select id="matchSelect" class="form-select">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø«Ù… Ø§Ø¶ØºØ· Â«ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§ØªÂ» â€”</option>
          </select>
        </div>
        <div class="col-12 col-md-4 d-grid">
          <button id="loadMatchesBtn" class="btn btn-primary">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</button>
        </div>
      </div>

      <hr>

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Ù„ØºØ© Ø§Ù„Ø¬ÙˆÙ„Ø©</label>
          <select id="roundLang" class="form-select">
            <option value="arabic" selected>Ø¹Ø±Ø¨ÙŠ (Ø§Ù„Ø¬ÙˆÙ„Ø© 7)</option>
            <option value="raw">ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù€ API</option>
          </select>
        </div>
        <div class="col-12 col-md-8 d-grid d-md-flex gap-2">
          <button id="generateBtn" class="btn btn-success flex-fill" disabled>âœï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±</button>
          <button id="rephraseBtn" class="btn btn-outline-primary flex-fill" disabled>ğŸ” ØºÙŠÙ‘Ø± Ø§Ù„ØµÙŠØ§ØºØ©</button>
          <button id="copyBtn" class="btn btn-outline-dark flex-fill" disabled>ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
          <button id="clearBtn" class="btn btn-outline-danger flex-fill">ğŸ§¹ Ù…Ø³Ø­</button>
        </div>
      </div>

      <div class="mt-4">
        <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ</label>
        <textarea id="newsOutput" rows="12" class="form-control" placeholder="Ù‡Ù†Ø§ Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø®..."></textarea>
      </div>

      <div id="statusArea" class="mt-3 text-muted small"></div>

      <div class="mt-3 small">
        Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø±Ø§Ø¬Ø¹ ØªÙˆØ«ÙŠÙ‚ API-SPORTS (Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©/Ø§Ù„Ù‡ÙŠØ¯Ø±): <code>https://www.api-football.com/documentation-v3#section/Authentication/API-SPORTS-Account</code>
      </div>

    </div>
  </div>
</div>

<script>
const HOSTS = {
  apisports: "https://v3.football.api-sports.io",
  rapidapi: "https://api-football-v1.p.rapidapi.com/v3"
};

const $ = id => document.getElementById(id);
function setStatus(html){ $("statusArea").innerHTML = html || ""; }
function fmtNum(n){ return new Intl.NumberFormat('ar-EG').format(n); }
function minuteArabic(min){ const m = parseInt(min,10); return isNaN(m)?`Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${min}`:`Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${fmtNum(m)}`; }
function toArabicRound(roundStr, fallback="Ø§Ù„Ø¬ÙˆÙ„Ø©"){
  if(!roundStr) return "";
  const m = roundStr.match(/-\s*(\d+)/);
  return m ? `${fallback} ${m[1]}` : roundStr;
}
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getHost(){ return HOSTS[$("provider").value] || HOSTS.apisports; }
function getHeaders(){
  const provider = $("provider").value;
  const key = $("apiKey").value.trim();
  if(!key) throw new Error("ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ù…ÙØªØ§Ø­ API ÙÙŠ Ø§Ù„Ø­Ù‚Ù„.");
  if(provider === "apisports"){
    return { "x-apisports-key": key };
  } else {
    return { "x-rapidapi-key": key, "x-rapidapi-host": "api-football-v1.p.rapidapi.com" };
  }
}

function getLeagueId(){
  const manual = $("leagueIdManual").value.trim();
  return manual ? manual : $("leagueSelect").value;
}

function getYMD(){
  const date = new Date();
  if($("daySelect").value === "yesterday") date.setDate(date.getDate()-1);
  return date.toISOString().slice(0,10);
}

// fetch helper with timeout
async function httpGet(path, {timeoutMs=12000}={}){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(getHost()+path, { headers: getHeaders(), signal: controller.signal });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t}`);
    }
    return await res.json();
  }catch(e){
    if(e.name==="AbortError") throw new Error("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©. Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
    throw e;
  }finally{ clearTimeout(timer); }
}

// UI actions
$("refreshBtn").addEventListener("click", ()=>{ setStatus("Ø¬Ø§Ù‡Ø². Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙˆØ§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø«Ù… ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø®Ø¨Ø±."); });
$("loadMatchesBtn").addEventListener("click", loadMatches);
$("generateBtn").addEventListener("click", generateNews);
$("rephraseBtn").addEventListener("click", ()=>{ if(lastPayload){ templateIdx++; $("newsOutput").value = buildReportText(lastPayload); }});
$("copyBtn").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText($("newsOutput").value); $("copyBtn").textContent="âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®"; setTimeout(()=>$("copyBtn").textContent="ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ",1200);}
  catch{ alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹."); }
});
$("clearBtn").addEventListener("click", ()=>{
  $("newsOutput").value="";
  $("rephraseBtn").disabled=true;
  $("copyBtn").disabled=true;
  setStatus("");
});

// load matches
async function loadMatches(){
  const leagueId = getLeagueId();
  if(!leagueId){ alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ League ID."); return; }
  const ymd = getYMD();
  setStatus(`Ø¬Ù„Ø¨ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ${ymd} Ù„Ù„Ø¯ÙˆØ±ÙŠ ${leagueId} <span class="spinner"></span>`);
  $("matchSelect").innerHTML = `<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>`;
  $("generateBtn").disabled = true;

  try{
    const data = await httpGet(`/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}`);
    const matches = data.response || [];
    if(!matches.length){
      $("matchSelect").innerHTML = `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</option>`;
      setStatus("Ù„Ø§ Ù…Ø¨Ø§Ø±ÙŠØ§Øª.");
      return;
    }
    $("matchSelect").innerHTML = "";
    for(const m of matches){
      const opt = document.createElement("option");
      opt.value = JSON.stringify({
        fixtureId: m.fixture.id,
        leagueId: leagueId,
        season: m.league?.season,
        homeId: m.teams?.home?.id,
        awayId: m.teams?.away?.id
      });
      opt.textContent = `${m.teams.home.name} Ø¶Ø¯ ${m.teams.away.name} â€” ${(m.goals.home ?? "")}:${(m.goals.away ?? "")}`;
      $("matchSelect").appendChild(opt);
    }
    $("generateBtn").disabled = false;
    setStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${matches.length} Ù…Ø¨Ø§Ø±Ø§Ø©.`);
  }catch(e){
    $("matchSelect").innerHTML = `<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>`;
    setStatus(`<span class="text-danger">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª: ${e.message}</span>`);
  }
}

// news generation
let lastPayload = null, templateIdx = 0;

function buildReportText(p){
  const arabicRound = (p.roundLang==="arabic") ? toArabicRound(p.roundStr) : p.roundStr;

  const goalsLine = p.goalEvents.length
    ? "Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø§Ø¡Øª Ø¹Ø¨Ø±: " + p.goalEvents.map(g => `${g.player} (${g.team}) ÙÙŠ ${minuteArabic(g.minute)}`).join(" / ") + "."
    : "";

  const redsLine = p.redCards.length
    ? "ÙˆØ´Ù‡Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡ Ø­Ø§Ù„Ø§Øª Ø·Ø±Ø¯: " + p.redCards.map(r => `${r.player} (${r.team}) ÙÙŠ ${minuteArabic(r.minute)}`).join(" / ") + "."
    : "";

  const outcome = (p.homeGoals>p.awayGoals) ? "Ø§Ù†ØªØµØ±" : (p.homeGoals<p.awayGoals) ? "Ø®Ø³Ø±" : "ØªØ¹Ø§Ø¯Ù„";

  const lead = [
    ()=>`${p.homeName} ${outcome==="Ø§Ù†ØªØµØ±"?"Ø­ØµØ¯":outcome==="Ø®Ø³Ø±"?"ÙØ´Ù„ ÙÙŠ Ù†ÙŠÙ„":"Ø§Ù‚ØªØ³Ù…"} Ø§Ù„Ù†Ù‚Ø§Ø· Ø£Ù…Ø§Ù… ${p.awayName} Ø¶Ù…Ù† ${p.leagueName}${arabicRound?" ÙÙŠ "+arabicRound:""}ØŒ ÙˆØ§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†ØªÙŠØ¬Ø© ${p.homeGoals}â€“${p.awayGoals}.`,
    ()=>`Ø¶Ù…Ù† ${p.leagueName}${arabicRound?` (${arabicRound})`:""}ØŒ ÙØ±Ø¶Øª Ù†ØªÙŠØ¬Ø© ${p.homeGoals}â€“${p.awayGoals} ÙƒÙ„Ù…ØªÙ‡Ø§ ÙÙŠ Ù…ÙˆØ§Ø¬Ù‡Ø© ${p.homeName} Ù…Ø¹ ${p.awayName}.`,
    ()=>`Ù…ÙˆØ§Ø¬Ù‡Ø© ${p.homeName} Ùˆ${p.awayName} ÙÙŠ ${p.leagueName}${arabicRound?" â€” "+arabicRound:""} Ø§Ù†ØªÙ‡Øª Ø¹Ù„Ù‰ ÙˆÙ‚Ø¹ ${p.homeGoals}â€“${p.awayGoals}.`
  ][templateIdx%3]();

  const mid = [
    ()=>goalsLine,
    ()=>goalsLine || "Ù„Ù… ØªÙØ³Ø¬Ù‘Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.",
    ()=>[goalsLine, redsLine].filter(Boolean).join(" ")
  ][templateIdx%3]();

  const tail = [
    ()=>`ÙˆÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ ÙŠØªÙ…ÙˆØ¶Ø¹ ${p.homeName} ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² ${fmtNum(p.homePos)} Ø¨ÙŠÙ†Ù…Ø§ ÙŠØ­ØªÙ„ ${p.awayName} Ø§Ù„Ù…Ø±ØªØ¨Ø© ${fmtNum(p.awayPos)}.`,
    ()=>`ØªØ±ØªÙŠØ¨ÙŠÙ‹Ø§: ${p.homeName} (${fmtNum(p.homePos)}) Ùˆ${p.awayName} (${fmtNum(p.awayPos)}).`,
    ()=>`Ø¹Ù„Ù‰ ØµØ¹ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ ${p.homeName} ${p.homePos} Ù…Ù‚Ø§Ø¨Ù„ ${p.awayPos} Ù„Ù€${p.awayName}.`
  ][templateIdx%3]();

  return [lead, mid, (redsLine && templateIdx%2? "": redsLine), tail].filter(Boolean).join("\n");
}

async function generateNews(){
  const sel = $("matchSelect").value;
  if(!sel){ alert("Ø§Ø®ØªØ± Ù…Ø¨Ø§Ø±Ø§Ø©."); return; }
  const { fixtureId, leagueId, season, homeId, awayId } = JSON.parse(sel);
  setStatus(`Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${fixtureId} <span class="spinner"></span>`);

  try{
    const fxData = await httpGet(`/fixtures?id=${fixtureId}`);
    const fx = fxData.response?.[0];
    if(!fx) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©.");

    const leagueName = fx.league?.name || "Ø§Ù„Ø¯ÙˆØ±ÙŠ";
    const roundStr   = fx.league?.round || "";
    const homeName   = fx.teams?.home?.name || "Ø§Ù„Ù…Ø¶ÙŠÙ";
    const awayName   = fx.teams?.away?.name || "Ø§Ù„Ø¶ÙŠÙ";
    const homeGoals  = fx.goals?.home ?? 0;
    const awayGoals  = fx.goals?.away ?? 0;

    // Events
    const evData = await httpGet(`/fixtures/events?fixture=${fixtureId}`);
    const ev = evData.response || [];
    const goals = ev.filter(e => e.type === "Goal").map(e=>({
      player: e.player?.name || "ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));
    const reds = ev.filter(e => e.detail === "Red Card").map(e=>({
      player: e.player?.name || "ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    // Standings
    const stData = await httpGet(`/standings?league=${leagueId}&season=${season}`);
    const groups = stData.response?.[0]?.league?.standings || [];
    const table = [].concat(...groups);
    const homeRow = table.find(r => r.team?.id === (homeId || fx.teams?.home?.id));
    const awayRow = table.find(r => r.team?.id === (awayId || fx.teams?.away?.id));
    const homePos = homeRow?.rank ?? "â€”";
    const awayPos = awayRow?.rank ?? "â€”";

    lastPayload = {
      leagueName, roundStr, roundLang: $("roundLang").value,
      homeName, awayName, homeGoals, awayGoals,
      goalEvents: goals, redCards: reds, homePos, awayPos
    };
    templateIdx = 0;
    $("newsOutput").value = buildReportText(lastPayload);
    $("rephraseBtn").disabled = false;
    $("copyBtn").disabled = false;
    setStatus("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±.");
  }catch(e){
    setStatus(`<span class="text-danger">ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±: ${e.message}</span>`);
  }
}
</script>
</body>
</html>
