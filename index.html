<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุญุฑุฑ ุฃุฎุจุงุฑ ูุฑุฉ ุงููุฏู โ API-SPORTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.06rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .spinner { display:inline-block; width:1.1rem; height:1.1rem; border:.18rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    code { direction:ltr; unicode-bidi:bidi-override; }
  </style>
</head>
<body class="p-3 p-md-4">

<div class="container">
  <h3 class="mb-3">๐ฐ ูุญุฑุฑ ุฃุฎุจุงุฑ ูุชุงุฆุฌ ูุฑุฉ ุงููุฏู</h3>

  <!-- API & Date -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">ุงููุฒููุฏ</label>
          <select id="provider" class="form-select">
            <option value="apisports" selected>API-SPORTS (ููุตู ุจู)</option>
            <option value="rapidapi">RapidAPI</option>
          </select>
          <div class="form-text">
            API-SPORTS: <code>https://v3.football.api-sports.io</code><br/>
            RapidAPI: <code>https://api-football-v1.p.rapidapi.com/v3</code>
          </div>
        </div>
        <div class="col-md-5">
          <label class="form-label">API Key</label>
          <input id="apiKey" class="form-control mono" type="password" placeholder="ุฃูุตู ููุชุงุญู ููุง">
          <div class="form-text">API-SPORTS: ุฑุฃุณ <code>x-apisports-key</code> โ RapidAPI: ุฑุฃุณ <code>x-rapidapi-key</code>.</div>
        </div>
        <div class="col-md-2">
          <label class="form-label">ุงูููู</label>
          <select id="daySelect" class="form-select">
            <option value="today">ุงูููู</option>
            <option value="yesterday">ุงูุฃูุณ</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">ุชุงุฑูุฎ (ุงุฎุชูุงุฑู)</label>
          <input id="dateManual" type="date" class="form-control">
          <div class="form-text">ููุถู ุชุฑูู ูุงุฑุบูุง ูุงูุงูุชูุงุก ุจุงูููู/ุงูุฃูุณ.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- League & Matches -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">ุงูุฏูุฑู (ูุงุฆูุฉ ุฌุงูุฒุฉ)</label>
          <select id="leagueSelect" class="form-select">
            <!-- ุฃุดูุฑ ุงูุฏูุฑูุงุช (API-FOOTBALL IDs) -->
            <option value="39">ุงูุฏูุฑู ุงูุฅูุฌููุฒู ุงูููุชุงุฒ (39)</option>
            <option value="140">ุงูุฏูุฑู ุงูุฅุณุจุงูู (140)</option>
            <option value="135">ุงูุฏูุฑู ุงูุฅูุทุงูู (135)</option>
            <option value="78">ุงูุฏูุฑู ุงูุฃููุงูู (78)</option>
            <option value="61">ุงูุฏูุฑู ุงููุฑูุณู (61)</option>
            <option value="2">ุฏูุฑู ุฃุจุทุงู ุฃูุฑูุจุง (2)</option>
            <option value="3">ุงูุฏูุฑู ุงูุฃูุฑูุจู (3)</option>
          </select>
          <div class="form-text">ููููู ุฃูุถูุง ุฅุฏุฎุงู League ID ูุฏูููุง ุจุงูุฃุณูู.</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">League ID (ุงุฎุชูุงุฑู)</label>
          <input id="leagueIdManual" class="form-control mono" type="text" placeholder="ูุซุงู: 39 โ ุฅู ุฃุฏุฎูุชู ุณูุชุฌุงูู ุงููุงุฆูุฉ ุฃุนูุงู">
        </div>
      </div>

      <div class="row g-3 mt-1 align-items-end">
        <div class="col-md-8">
          <label class="form-label">ุงููุจุงุฑุงุฉ</label>
          <select id="matchSelect" class="form-select">
            <option value="">โ ุงุฎุชุฑ ุงูุฏูุฑู ุซู ุงุถุบุท ยซุชุญููู ุงููุจุงุฑูุงุชยป โ</option>
          </select>
        </div>
        <div class="col-md-4 d-grid">
          <button id="loadMatchesBtn" class="btn btn-primary">๐ฅ ุชุญููู ุงููุจุงุฑูุงุช</button>
        </div>
      </div>

      <div id="statusArea" class="mt-3 text-muted small"></div>
    </div>
  </div>

  <!-- Controls & Output -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">ูุบุฉ ุงูุฌููุฉ</label>
          <select id="roundLang" class="form-select">
            <option value="arabic" selected>ุนุฑุจู (ุงูุฌููุฉ 7)</option>
            <option value="raw">ููุง ูู ุงูู API</option>
          </select>
        </div>
        <div class="col-md-8 d-grid d-md-flex gap-2">
          <button id="generateBtn" class="btn btn-success flex-fill" disabled>โ๏ธ ุชูููุฏ ุงูุฎุจุฑ</button>
          <button id="rephraseBtn" class="btn btn-outline-primary flex-fill" disabled>๐ ุบููุฑ ุงูุตูุงุบุฉ</button>
          <button id="copyBtn" class="btn btn-outline-dark flex-fill" disabled>๐ ูุณุฎ ุงููุต</button>
          <button id="clearBtn" class="btn btn-outline-danger flex-fill">๐งน ูุณุญ</button>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">ุงููุต ุงูุฅุฎุจุงุฑู</label>
        <textarea id="newsOutput" rows="12" class="form-control" placeholder="ุณูุธูุฑ ุงูุฎุจุฑ ููุง..."></textarea>
      </div>
    </div>
  </div>

  <div class="text-muted small mt-3">
    **ููุงุญุธุฉ ุฃูุงู**: ุงุฌุนู ุงูููุชุงุญ ููููุฏูุง ุนูู ูุทุงู GitHub Pages ุงูุฎุงุต ุจู ูู ููุญุฉ API-FOOTBALL.
  </div>
</div>

<script>
/* ========== Helpers ========== */
const HOSTS = {
  apisports: "https://v3.football.api-sports.io",
  rapidapi: "https://api-football-v1.p.rapidapi.com/v3"
};
const $ = id => document.getElementById(id);
function setStatus(html){ $("statusArea").innerHTML = html || ""; }
function fmtNum(n){ return new Intl.NumberFormat('ar-EG').format(n); }
function minuteArabic(m){ const x=parseInt(m,10); return isNaN(x)?`ุงูุฏูููุฉ ${m}`:`ุงูุฏูููุฉ ${fmtNum(x)}`; }
function toArabicRound(roundStr){
  if(!roundStr) return "";
  const m = roundStr.match(/-\s*(\d+)/);
  return m ? `ุงูุฌููุฉ ${m[1]}` : roundStr;
}
function getHost(){ return HOSTS[$("provider").value] || HOSTS.apisports; }
function getHeaders(){
  const key = $("apiKey").value.trim();
  if(!key) throw new Error("ูุฑุฌู ูุตู API Key.");
  return ($("provider").value==="apisports")
    ? { "x-apisports-key": key }
    : { "x-rapidapi-key": key, "x-rapidapi-host": "api-football-v1.p.rapidapi.com" };
}
function getLeagueId(){ return $("leagueIdManual").value.trim() || $("leagueSelect").value; }
function getYMD(){
  const manual = $("dateManual").value;
  if (manual) return manual; // YYYY-MM-DD
  const d = new Date();
  if ($("daySelect").value === "yesterday") d.setDate(d.getDate()-1);
  return d.toISOString().slice(0,10);
}
async function httpGet(path, {timeoutMs=12000}={}){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(getHost()+path, { headers: getHeaders(), signal: controller.signal });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    return await res.json();
  }catch(e){
    if(e.name==="AbortError") throw new Error("ุงูุชูุช ุงููููุฉ. ุฃุนุฏ ุงููุญุงููุฉ.");
    throw e;
  }finally{ clearTimeout(timer); }
}

/* ========== Smart Fixtures Fetch ========== */
async function tryFixtures(urls) {
  let lastUrl = "", lastErr = null;
  for (const u of urls) {
    try {
      const data = await httpGet(u);
      const arr = data.response || [];
      if (arr.length) return { ok: true, url: u, fixtures: arr };
      lastUrl = u;
    } catch (e) { lastUrl = u; lastErr = e; }
  }
  return { ok: false, url: lastUrl, fixtures: [], err: lastErr };
}

/* ========== Load Matches ========== */
document.getElementById("loadMatchesBtn").onclick = async () => {
  const leagueId = getLeagueId();
  if(!leagueId){ alert("ุงุฎุชุฑ ุงูุฏูุฑู ุฃู ุฃุฏุฎู League ID."); return; }
  const ymd = getYMD();

  setStatus(`ุฌูุจ ูุจุงุฑูุงุช ${ymd} ููุฏูุฑู ${leagueId}โฆ <span class="spinner"></span>`);
  $("matchSelect").innerHTML = `<option>ุฌุงุฑู ุงูุชุญููู...</option>`;
  $("generateBtn").disabled = true;

  const urls = [
    `/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}&timezone=Asia/Qatar`,
    `/fixtures?league=${encodeURIComponent(leagueId)}&date=${ymd}`,
    `/fixtures?league=${encodeURIComponent(leagueId)}&from=${ymd}T00:00&to=${ymd}T23:59&timezone=Asia/Qatar`,
    `/fixtures?from=${ymd}T00:00&to=${ymd}T23:59&timezone=Asia/Qatar`
  ];
  const res = await tryFixtures(urls);

  let fixtures = res.fixtures;
  if (res.ok && res.url.startsWith("/fixtures?from=")) {
    // ุขุฎุฑ ูุญุงููุฉ ุจุฏูู league โ ุฑุดูุญ ูุญูููุง
    fixtures = fixtures.filter(f => String(f.league?.id) === String(leagueId));
  }

  if (!res.ok || !fixtures.length) {
    setStatus(`<span class="text-danger">ูุง ุชูุฌุฏ ูุจุงุฑูุงุช ุญุณุจ ูุฏุฎูุงุชู. ุขุฎุฑ ูุญุงููุฉ: <code>${res.url || "โ"}</code>${res.err ? " โ " + res.err : ""}</span>`);
    $("matchSelect").innerHTML = `<option value="">ูุง ูุจุงุฑูุงุช</option>`;
    return;
  }

  $("matchSelect").innerHTML = "";
  fixtures.forEach(f => {
    const opt = document.createElement("option");
    opt.value = JSON.stringify({
      fixtureId: f.fixture.id,
      leagueId: leagueId,
      season: f.league?.season,
      homeId: f.teams?.home?.id,
      awayId: f.teams?.away?.id
    });
    opt.textContent = `${f.teams.home.name} ุถุฏ ${f.teams.away.name} โ ${(f.goals.home ?? "")}:${(f.goals.away ?? "")}`;
    $("matchSelect").appendChild(opt);
  });

  $("generateBtn").disabled = false;
  setStatus(`ุชู ุชุญููู ${fixtures.length} ูุจุงุฑุงุฉ. (ุงููุตุฏุฑ: <code>${res.url}</code>)`);
};

/* ========== News Generation ========== */
let lastPayload = null, templateIdx = 0;

function buildReport(p){
  const round = ($("roundLang").value === "arabic") ? toArabicRound(p.roundStr) : p.roundStr;

  const goalsLine = p.goals.length
    ? "ุฃูุฏุงู ุงููุจุงุฑุงุฉ ุฌุงุกุช ุนุจุฑ: " + p.goals.map(g => `${g.player} (${g.team}) ูู ${minuteArabic(g.minute)}`).join(" / ") + "."
    : "";

  const redsLine = p.reds.length
    ? "ูุดูุฏ ุงูููุงุก ุญุงูุงุช ุทุฑุฏ: " + p.reds.map(r => `${r.player} (${r.team}) ูู ${minuteArabic(r.minute)}`).join(" / ") + "."
    : "";

  const outcome = (p.homeGoals>p.awayGoals) ? "ุงูุชุตุฑ" : (p.homeGoals<p.awayGoals) ? "ุฎุณุฑ" : "ุชุนุงุฏู";

  const leadVariants = [
    ()=>`${p.home} ${outcome==="ุงูุชุตุฑ"?"ุญุตุฏ":outcome==="ุฎุณุฑ"?"ูุดู ูู ููู":"ุงูุชุณู"} ุงูููุงุท ุฃูุงู ${p.away} ุถูู ${p.league}${round? " ูู "+round:""}ุ ูุงูุชูุช ุงูููุงุฌูุฉ ุจูุชูุฌุฉ ${p.homeGoals}โ${p.awayGoals}.`,
    ()=>`ุถูู ${p.league}${round? " ("+round+")": ""}ุ ูุฑุถุช ูุชูุฌุฉ ${p.homeGoals}โ${p.awayGoals} ูููุชูุง ูู ููุงุฌูุฉ ${p.home} ูุน ${p.away}.`,
    ()=>`ุญููุช ููุงุฌูุฉ ${p.home} ู${p.away} ูู ${p.league}${round? " โ "+round:""} ุฅุซุงุฑุฉ ูุจูุฑุฉุ ูุงูุชูุช ุนูู ููุน ${p.homeGoals}โ${p.awayGoals}.`
  ];
  const midVariants = [
    ()=>goalsLine,
    ()=> goalsLine || "ูู ุชูุณุฌูู ุชูุงุตูู ุงูุฃูุฏุงู ูู ุงูุณุฌูุงุช ุงููุชุงุญุฉ.",
    ()=> [goalsLine, redsLine].filter(Boolean).join(" ")
  ];
  const tailVariants = [
    ()=>`ููู ุฌุฏูู ุงูุชุฑุชูุจุ ูุชููุถุน ${p.home} ูู ุงููุฑูุฒ ${fmtNum(p.homePos)} ุจูููุง ูุญุชู ${p.away} ุงููุฑุชุจุฉ ${fmtNum(p.awayPos)}.`,
    ()=>`ุชุฑุชูุจููุง: ${p.home} (${fmtNum(p.homePos)}) ู${p.away} (${fmtNum(p.awayPos)}).`,
    ()=>`ุนูู ุตุนูุฏ ุงูุฌุฏููุ ${p.home} ${p.homePos} ููุงุจู ${p.awayPos} ูู${p.away}.`
  ];

  return [
    leadVariants[templateIdx % leadVariants.length](),
    midVariants[templateIdx % midVariants.length](),
    (redsLine && templateIdx % 2 === 1) ? "" : redsLine,
    tailVariants[templateIdx % tailVariants.length]()
  ].filter(Boolean).join("\n");
}

document.getElementById("generateBtn").onclick = async () => {
  const sel = $("matchSelect").value;
  if(!sel){ alert("ุงุฎุชุฑ ูุจุงุฑุงุฉ."); return; }
  const { fixtureId, leagueId, season, homeId, awayId } = JSON.parse(sel);
  setStatus(`ุฌูุจ ุชูุงุตูู ุงููุจุงุฑุงุฉ ${fixtureId}โฆ <span class="spinner"></span>`);

  try{
    const fxData = await httpGet(`/fixtures?id=${fixtureId}`);
    const fx = fxData.response?.[0];
    if(!fx) throw new Error("ูุง ุชูุฌุฏ ุจูุงูุงุช ูููุจุงุฑุงุฉ.");

    const leagueName = fx.league?.name || "ุงูุฏูุฑู";
    const roundStr   = fx.league?.round || "";
    const homeName   = fx.teams?.home?.name || "ุงููุถูู";
    const awayName   = fx.teams?.away?.name || "ุงูุถูู";
    const homeGoals  = fx.goals?.home ?? 0;
    const awayGoals  = fx.goals?.away ?? 0;

    const evData = await httpGet(`/fixtures/events?fixture=${fixtureId}`);
    const ev = evData.response || [];
    const goals = ev.filter(e => e.type === "Goal").map(e => ({
      player: e.player?.name || "ุบูุฑ ูุนููู",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));
    const reds = ev.filter(e => e.detail === "Red Card").map(e => ({
      player: e.player?.name || "ุบูุฑ ูุนููู",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    const stData = await httpGet(`/standings?league=${leagueId}&season=${season}`);
    const groups = stData.response?.[0]?.league?.standings || [];
    const table  = [].concat(...groups);
    const homePos = table.find(r => r.team?.id === (homeId || fx.teams?.home?.id))?.rank ?? "โ";
    const awayPos = table.find(r => r.team?.id === (awayId || fx.teams?.away?.id))?.rank ?? "โ";

    lastPayload = {
      league: leagueName, roundStr,
      home: homeName, away: awayName,
      homeGoals, awayGoals,
      goals, reds, homePos, awayPos
    };
    templateIdx = 0;
    $("newsOutput").value = buildReport(lastPayload);
    $("rephraseBtn").disabled = false;
    $("copyBtn").disabled = false;
    setStatus("ุชู ุชูููุฏ ุงูุฎุจุฑ.");
  }catch(e){
    setStatus(`<span class="text-danger">ูุดู ุชูููุฏ ุงูุฎุจุฑ: ${e.message}</span>`);
  }
};

document.getElementById("rephraseBtn").onclick = () => { if(lastPayload){ templateIdx++; $("newsOutput").value = buildReport(lastPayload); } };
document.getElementById("copyBtn").onclick = async () => {
  try{ await navigator.clipboard.writeText($("newsOutput").value); setStatus("โ ุชู ูุณุฎ ุงููุต"); }
  catch{ alert("ูู ูุชู ุงููุณุฎ ุชููุงุฆููุง. ุงูุณุฎ ูุฏูููุง."); }
};
document.getElementById("clearBtn").onclick = () => { $("newsOutput").value=""; setStatus(""); };
</script>
</body>
</html>
